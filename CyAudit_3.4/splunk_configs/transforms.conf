# CyAudit Splunk Configuration - transforms.conf
# Version: 1.0
# Purpose: Field transformations and sourcetype routing

################################################################################
# Sourcetype Routing Based on Filename
################################################################################

[cyaudit_sourcetype_routing]
# Routes files to correct sourcetypes based on filename pattern
# Pattern: cyaudit_<type>.json â†’ sourcetype::cyaudit:<type>

REGEX = /cyaudit_(\w+)\.json
FORMAT = sourcetype::cyaudit:$1
DEST_KEY = MetaData:Sourcetype
WRITE_META = true

################################################################################
# Sourcetype Override for HEC Events
################################################################################

[cyaudit_hec_sourcetype]
# When using HEC, sourcetype is extracted from event.sourcetype field
# This transform is applied automatically by HEC

SOURCE_KEY = _raw
REGEX = "sourcetype"\s*:\s*"([^"]+)"
FORMAT = sourcetype::$1
DEST_KEY = MetaData:Sourcetype
WRITE_META = true

################################################################################
# Field Extractions and Transformations
################################################################################

# Note: Most field extractions are handled via KV_MODE=json in props.conf
# These transforms are for special cases that require regex-based extraction

[extract_ip_addresses]
# Extract individual IP addresses from IPAddresses multi-value field
SOURCE_KEY = IPAddresses
REGEX = ([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})
FORMAT = ip::$1
MV_ADD = true

[extract_kb_number]
# Extract KB number from patch descriptions
SOURCE_KEY = HotFixID
REGEX = KB(\d+)
FORMAT = kb_number::$1

[extract_stig_category]
# Extract STIG category from STIG_ID
SOURCE_KEY = STIG_ID
REGEX = SV-(\d+)
FORMAT = stig_vuln_id::$1

################################################################################
# Lookup Tables
################################################################################

# Registry type code translation
[registry_type_lookup]
filename = registry_types.csv
max_matches = 1
min_matches = 1
default_match = Unknown

# FileSystemRights code translation
[filesystemrights_lookup]
filename = filesystemrights.csv
max_matches = 1
min_matches = 1
default_match = Unknown

# STIG severity mapping
[stig_severity_lookup]
filename = stig_severity.csv
max_matches = 1
min_matches = 1
default_match = Informational

################################################################################
# Field Aliases and Calculated Fields
################################################################################
# Note: Field aliases are defined in props.conf using FIELDALIAS
# Calculated fields are defined in props.conf using EVAL

################################################################################
# Index-Time Field Extraction (Use Sparingly)
################################################################################
# By default, we use search-time extraction (KV_MODE=json) for flexibility
# and reduced index size. Only use index-time extraction for high-performance
# requirements with tstats command.

# Example (disabled by default):
# [cyaudit_index_time_fields]
# REGEX = "computer_name"\s*:\s*"([^"]+)"
# FORMAT = computer_name::$1
# WRITE_META = true

################################################################################
# Data Masking and Anonymization (Optional)
################################################################################
# Uncomment if you need to mask sensitive data before indexing

# [mask_usernames]
# REGEX = ("UserName"\s*:\s*)"([^"]+)"
# FORMAT = $1"***MASKED***"
# DEST_KEY = _raw

# [mask_ip_addresses]
# REGEX = \b(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})\b
# FORMAT = XXX.XXX.XXX.$4
# DEST_KEY = _raw

################################################################################
# Event Deduplication
################################################################################
# CyAudit data should not have duplicates from transformation script,
# but this can be enabled if needed

# [cyaudit_dedup]
# DEST_KEY = queue
# FORMAT = nullQueue
# REGEX = ^(?:.*\n)*?\1

################################################################################
# Host Extraction
################################################################################

[extract_host_from_computer_name]
# Extract host from computer_name field
SOURCE_KEY = computer_name
REGEX = (.+)
FORMAT = host::$1
DEST_KEY = MetaData:Host
WRITE_META = true

################################################################################
# Custom Index Routing (Optional)
################################################################################
# Route different event types to different indexes if needed

# [route_stig_to_compliance_index]
# REGEX = "event_type"\s*:\s*"stig_compliance"
# FORMAT = compliance
# DEST_KEY = _MetaData:Index
# WRITE_META = true

# [route_services_to_inventory_index]
# REGEX = "sourcetype"\s*:\s*"cyaudit:services"
# FORMAT = inventory
# DEST_KEY = _MetaData:Index
# WRITE_META = true

################################################################################
# Notes
################################################################################
#
# Search-Time vs Index-Time Extraction:
# - This configuration uses search-time extraction (default)
# - Benefits: 60-70% smaller index, more flexible, lower license cost
# - Drawbacks: Slightly slower searches (minimal impact for most use cases)
#
# If you need index-time extraction:
# 1. Add INDEXED_EXTRACTIONS = json to props.conf
# 2. Add KV_MODE = none to props.conf on search heads
# 3. Accept 200-300% larger index size
# 4. Accept higher license consumption
#
# For most CyAudit deployments with weekly/monthly ingestion,
# search-time extraction is the recommended approach.
#
